@name OpenControl/controlstand-aarlogic
@inputs ControlStand:entity Pod:entity BrakeCutout [LOCOMOTIVE_DATA CONFIGURATION_DATA]:array
@outputs [CONTROL_STAND_DATA]:array
@persist Driver:entity
@persist InServiceZone LocalEmergency IncreaseTrainBrake DecreaseTrainBrake BrakeNotch ServiceZone AutomaticPressureSet Suppression Emergency Independent_Apply Independent_Release Independent_Bail
@persist 
@trigger none 
@model

CONTROL_STAND_DATA = array(IncreaseTrainBrake,DecreaseTrainBrake,BrakeNotch,AutomaticPressureSet,Suppression,Emergency,BrakeCutout,Independent_Apply,Independent_Release,Independent_Bail)

if(dupefinished() | duped()){ reset() }
if(first()){ 

}

runOnKeys(Driver,1) 
interval(150)


Driver = Pod:driver()

Shifting = Driver:keyPressed("lshift")

IncreaseTrainBrake = Driver:keyPressed("w") & Shifting
DecreaseTrainBrake = Driver:keyPressed("s") & Shifting

Independent_Apply = Driver:keyPressed("rbracket")
Independent_Release = Driver:keyPressed("lbracket")
Independent_Bail = Driver:keyPressed("slash")


if(!InServiceZone){
    if(changed(IncreaseTrainBrake & BrakeNotch<5)&IncreaseTrainBrake & BrakeNotch<5){
        BrakeNotch += 1    
    }
    
    if(changed(DecreaseTrainBrake & BrakeNotch>0)&DecreaseTrainBrake & BrakeNotch>0){
        BrakeNotch -= 1   
    }
}

if(BrakeNotch == 2){
    InServiceZone = 1
    if(IncreaseTrainBrake & ServiceZone<20){
        ServiceZone += 1
    }
    if(DecreaseTrainBrake & ServiceZone>0){
        ServiceZone -= 1
    }
}

if(ServiceZone==20){
    InServiceZone = 0
}
elseif(ServiceZone==0){
    InServiceZone = 0
}

switch(BrakeNotch){
    case 0,
        ControlStand:setBodygroup(4,0)
        AutomaticPressureSet = 90
        Suppression = 0
    break
    case 1,
        ControlStand:setBodygroup(4,1)
        AutomaticPressureSet = 80
        Suppression = 0
    break
    case 2,
        ControlStand:setBodygroup(4,2+round((ServiceZone*(50/20))/10))
        AutomaticPressureSet = 80-ServiceZone
        Suppression = 0
    break
    case 3,
        ControlStand:setBodygroup(4,8)
        if(!LocalEmergency){
            Suppression = 1
        }
    break
    case 4,
        ControlStand:setBodygroup(4,10)
        Suppression = 0
        AutomaticPressureSet = 0
    break
    case 5,
        ControlStand:setBodygroup(4,11)
        AutomaticPressureSet = 0
        LocalEmergency = 1
        Suppression = 1
        Emergency = 1
    break
}

if(!Independent_Bail){
ControlStand:setBodygroup(5,1+LOCOMOTIVE_DATA[4,number]/10)
}
elseif(Independent_Bail){
ControlStand:setBodygroup(5,0)
}

if(changed(Independent_Bail)&Independent_Bail){
    soundPlay("indbailoff",0,"opencontrol/airbrakes/sa26/bail_off2.wav")
}
elseif(changed(Independent_Bail)&!Independent_Bail){
    soundPlay("indbailon",0,"opencontrol/airbrakes/sa26/bail_on2.wav")    
}


if(changed(LocalEmergency & BrakeNotch<2)&LocalEmergency & BrakeNotch<2){
    timer("emrgtimeout",60000)    
}

if(clk("emrgtimeout")){
    LocalEmergency = 0
    stoptimer("emrgtimeout")
}

if(LocalEmergency == 0 & BrakeNotch<2){
    Emergency = 0
}
