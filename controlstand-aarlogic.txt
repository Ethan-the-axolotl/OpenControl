@name OpenControl/controlstand-aarlogic
@inputs ControlStand:entity Pod:entity
@outputs IncreaseTrainBrake DecreaseTrainBrake BrakeNotch ServiceZone AutomaticPressureSet
@persist Driver:entity
@persist InServiceZone
@persist 
@trigger 
@model

if(dupefinished() | duped()){ reset() }
if(first()){ 
    
}
runOnKeys(Driver,1) 
interval(150)
Driver = Pod:driver()

Shifting = Driver:keyPressed("lshift")

IncreaseTrainBrake = Driver:keyPressed("w") & Shifting
DecreaseTrainBrake = Driver:keyPressed("s") & Shifting

if(!InServiceZone){
    if(changed(IncreaseTrainBrake & BrakeNotch<5)&IncreaseTrainBrake & BrakeNotch<5){
        BrakeNotch += 1    
    }
    
    if(changed(DecreaseTrainBrake & BrakeNotch>0)&DecreaseTrainBrake & BrakeNotch>0){
        BrakeNotch -= 1   
    }
}

if(BrakeNotch == 2){ #service zone (un-notched)
    InServiceZone = 1
    
    if(IncreaseTrainBrake & ServiceZone<20){
        ServiceZone += 5
    }
    
    if(DecreaseTrainBrake & ServiceZone>0){
        ServiceZone -= 5
    }
}

if(ServiceZone==50){
    InServiceZone = 0
}
elseif(ServiceZone==0){
    InServiceZone = 0
}

switch(BrakeNotch){
    case 0, #Relase
        ControlStand:setBodygroup(4,0)
        AutomaticPressureSet = 90
    break
    case 1, #Ini Red
        ControlStand:setBodygroup(4,1)
        AutomaticPressureSet = 80
    break
    case 2, #ServiceZone
        ControlStand:setBodygroup(4,2+round((ServiceZone/10)))
        AutomaticPressureSet = 80-ServiceZone
    break
    case 3, #Supp
        ControlStand:setBodygroup(4,8)
    break
    case 4, #Hand Off
        ControlStand:setBodygroup(4,10)
    break
    case 5, #Emrg
        ControlStand:setBodygroup(4,11)
        AutomaticPressureSet = 0
    break
}

